<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="仅仅作为学习记录">
<meta property="og:type" content="website">
<meta property="og:title" content="笔记">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="笔记">
<meta property="og:description" content="仅仅作为学习记录">
<meta property="og:locale">
<meta property="article:author" content="XiaoMao">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="笔记" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">笔记</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-2021-11-22-generator和js调用堆栈-md" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/22/2021-11-22-generator%E5%92%8Cjs%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88-md/" class="article-date">
  <time class="dt-published" datetime="2021-11-22T15:37:52.000Z" itemprop="datePublished">2021-11-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/11/22/2021-11-22-generator%E5%92%8Cjs%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88-md/">2021-11-22-generator和js调用堆栈.md</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="generator的es5实现"><a href="#generator的es5实现" class="headerlink" title="generator的es5实现"></a>generator的es5实现</h2><p>在<a target="_blank" rel="noopener" href="https://github.com/facebook/regenerator">regenerator-runtime</a>中有对generator的详细es5实现,我们实现一个最简单的 generator如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>cb cb为编译后的generator函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generator</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;</span><br><span class="line">      <span class="attr">next</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">stop</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">next</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> res = cb(obj);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">value</span>: <span class="literal">undefined</span>,</span><br><span class="line">          <span class="attr">done</span>: res === <span class="literal">undefined</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;)();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">1</span> + <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// es5版的generator函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a;</span><br><span class="line">  <span class="comment">// 编译后</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">$cb</span>(<span class="params">_context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> ((_context.prev = _context.next)) &#123;</span><br><span class="line">        <span class="comment">// 可以发现通过 yield 将代码分割成几块</span></span><br><span class="line">        <span class="comment">// 每次执行 next 函数就执行一块代码</span></span><br><span class="line">        <span class="comment">// 并且表明下次需要执行哪块代码</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">          a = <span class="number">1</span> + <span class="number">2</span>;</span><br><span class="line">          _context.next = <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">          _context.next = <span class="number">6</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// 执行完毕</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;end&quot;</span>:</span><br><span class="line">          <span class="keyword">return</span> _context.stop();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> generator($cb);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> t = _test()</span><br><span class="line">t.next()</span><br><span class="line"><span class="comment">// &#123;value: undefined, done: false&#125;</span></span><br><span class="line">t.next()</span><br><span class="line"><span class="comment">// &#123;value: undefined, done: false&#125;</span></span><br><span class="line">t.next()</span><br><span class="line"><span class="comment">// &#123;value: undefined, done: true&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="在上面拼夕夕的generator函数基础上我们来看看js调用堆栈"><a href="#在上面拼夕夕的generator函数基础上我们来看看js调用堆栈" class="headerlink" title="在上面拼夕夕的generator函数基础上我们来看看js调用堆栈"></a>在上面拼夕夕的generator函数基础上我们来看看js调用堆栈</h2><h3 id="首先先了解什么是执行上下文"><a href="#首先先了解什么是执行上下文" class="headerlink" title="首先先了解什么是执行上下文"></a>首先先了解什么是执行上下文</h3><p>执行上下文就是当前JavaScript代码被解析和执行是所在环境的抽象概念，JavaScript中运行任何的代码都是在执行上下文中运行。</p>
<h3 id="执行上下文的类型，总共有三类"><a href="#执行上下文的类型，总共有三类" class="headerlink" title="执行上下文的类型，总共有三类"></a>执行上下文的类型，总共有三类</h3><blockquote>
<ul>
<li>全局执行上下文：这是默认的，最基础的执行上下文。不在任何函数中的代码都位于全局执行上下文中。共有两个过程：1.创建有全局对象，在浏览器中这个全局对象就是window对象。2.将this指针指向这个全局对象。一个程序中只能存在一个执行上下文。</li>
<li>函数执行上下文：每次调用函数时，都会为该函数创建一个新的执行上下文。每个函数都拥有自己的执行上下文，但是只有在函数被调用的时候才会被创建。一个程序中可以存在多个函数执行上下文，这些函数执行上下文按照特定的顺序执行一系列步骤，后文具体讨论。</li>
<li>Eval函数执行上下文：运行在eval函数中的代码也获得了自己的执行上下文，但由于Eval较为少用到，也不建议使用，就不去详细讨论了。。。（eval方法是在运行时对脚本进行解释执行，而普通的javascript会有一个预处理的过程。所以会有一些性能上的损失；eval也存在一个安全问题，因为它可以执行传给它的任何字符串，所以永远不要传入字符串或者来历不明和不受信任源的参数。</li>
</ul>
</blockquote>
<h3 id="执行栈"><a href="#执行栈" class="headerlink" title="执行栈"></a>执行栈</h3><p>执行栈，也叫调用栈，用于存储在代码执行期间创建的所有执行上下文。</p>
<p>当JavaScript引擎首次读取脚本时，会创建一个全局执行上下文并将其Push到当前执行栈中。每当发生函数调用时，引擎都会为该函数创建一个新的执行上下文并Push到当前执行栈的栈顶。</p>
<p>引擎会运行执行上下文在执行栈栈顶的函数，当此函数运行完成后，其对应的执行上下文将会从执行栈中Pop出，上下文控制权将转到当前执行栈的下一个执行上下文。</p>
<p>先上一段js代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">funtion <span class="function"><span class="title">b</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(a)&#125;;</span><br><span class="line">b();</span><br></pre></td></tr></table></figure>
<p>在这个过程中全局执行上下文入栈-&gt;a执行上下文入栈-&gt;a执行上下文出栈最后只剩下了全局执行上下文，回到generator那边最后明明是在全局上下文里执行的<code>t.next()</code>为啥还是正确的结果呢？这就和执行上下文创建以及闭包和js堆栈相关了。先来看看执行上下文的创建。<br>执行上下文分两个阶段创建：1.创建阶段； 2.执行阶段</p>
<h3 id="创建阶段"><a href="#创建阶段" class="headerlink" title="创建阶段"></a>创建阶段</h3><p>在任意的JavaScript代码被执行前，执行上下文处于创建阶段。在创建阶段总共发生了三件事情：</p>
<blockquote>
<ol>
<li>确定this的值，也被称为This Binding(this的值大家伙都整挺明白的略过)；</li>
<li>LexicaEnvironment（词法环境）组件被创建；</li>
<li>VariableEnvironment（变量环境）组件被创建。</li>
</ol>
</blockquote>
<h4 id="词法环境（Lexical-Environment"><a href="#词法环境（Lexical-Environment" class="headerlink" title="词法环境（Lexical Environment):"></a>词法环境（Lexical Environment):</h4><p>官方ES6文档将词法环境定义为：</p>
<p>词法环境是一种规范类型，基于 ECMAScript 代码的词法嵌套结构来定义标识符与特定变量和函数的关联关系。词法环境由环境记录（environment record）和可能为空引用（null）的外部词法环境组成。<br>简而言之，词法环境是一个包含标识符变量映射的结构。（这里的标识符表示变量/函数的名称，变量是对实际对象【包括函数类型对象】或原始值的引用）</p>
<p>在词法环境中，有两个组成部分：</p>
<blockquote>
<ol>
<li>环境记录（environment record）: 环境记录是存储变量和函数声明的实际位置</li>
<li>对外部环境的引用: 对外部环境的引用意味着它可以访问其外部词法环境</li>
</ol>
</blockquote>
<p>词法环境有两种类型：</p>
<blockquote>
<ol>
<li>全局环境（在全局执行上下文中）是一个没有外部环境词法环境的词法环境。全局环境的外部环境引用为null。它拥有一个全局对象（window对象）及其关联的方法和属性（例如数组方法）以及任何用户自定义的全局变量，this的值指向这个全局对象。</li>
<li>函数环境，用户在函数中定义的变量被存储在环境记录中，包含了arguments对象。对外部环境的引用可以是全局环境，也可以是包含内部函数的外部函数环境。<br>注意：对于函数环境而言，环境记录还包含了一个arguments对象，该对象包含了索引和传递给函数的参数之间的映射以及传递给函数的参数的长度（数量）。</li>
</ol>
</blockquote>
<p>环境记录同样也有两种类型：</p>
<blockquote>
<ol>
<li>声明性环境记录存储变量，函数和参数。一个函数环境包含声明性环境记录。</li>
<li>对象环境记录用于定义在全局执行上下文中出现的变量和函数的关联。全局环境包含对象环境记录。</li>
</ol>
</blockquote>
<h4 id="变量环境："><a href="#变量环境：" class="headerlink" title="变量环境："></a>变量环境：</h4><p>变量环境是一个词法环境，因此它具有上面定义的词法环境的所有属性。</p>
<p>在 ES6 中，词法环境（LexicalEnvironment 组件）和 变量环境（VariableEnvironment 组件）的区别在于前者用于存储函数声明和变量（ let 和 const ）绑定，而后者仅用于存储变量（ var ）绑定。</p>
<p>当然一个generator并不需要说这些，但是多看一点总是好的。</p>
<h3 id="执行阶段"><a href="#执行阶段" class="headerlink" title="执行阶段"></a>执行阶段</h3><p>这里就长话短说了， 此阶段，完成对所有变量的分配，最后执行代码。<br>回到最开始generator的代码，在<code>_test</code>函数执行的过程中创建了属于它的执行上下文，执行上下文中的变量环境中存储了<code>a</code>,事实上它是被存储在堆内存中，这也是闭包的原理，我们执行<code>t.next()</code>的时候是访问了全局上下文中的<code>t</code>，虽然<code>_test</code>的执行上下文以及出栈了但是我们仍然能从堆中访问到<code>a</code>,每次执行<code>t.next()</code>都有一次它执行上下文的出栈和入栈，这也是generator执行权交换的过程，在它的执行上下文出栈后执行权就交还给了栈顶的执行上下文，看起来就像是只原本<code>test</code>函数中的部分代码块。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>事实上es5实现generator主要的功劳还得靠babel编译generator函数给它转换为一个状态机，闭包、作用域之类的其实是耳熟能详的知识，但是用generator的时候没有去思考过它怎么实现的，以后遇到一些常用却不了解原理的还得自己去猜一猜然后再去验证这样能加深理解。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/11/22/2021-11-22-generator%E5%92%8Cjs%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88-md/" data-id="ckwainvom0000dorjhiteda19" data-title="2021-11-22-generator和js调用堆栈.md" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/11/22/hello-world/" class="article-date">
  <time class="dt-published" datetime="2021-11-22T10:18:35.448Z" itemprop="datePublished">2021-11-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/11/22/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/11/22/hello-world/" data-id="ckwainvov0005dorj9vlhhsa4" data-title="Hello World" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2021-9-6-约瑟夫环-md" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/09/06/2021-9-6-%E7%BA%A6%E7%91%9F%E5%A4%AB%E7%8E%AF-md/" class="article-date">
  <time class="dt-published" datetime="2021-09-06T21:52:41.000Z" itemprop="datePublished">2021-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/09/06/2021-9-6-%E7%BA%A6%E7%91%9F%E5%A4%AB%E7%8E%AF-md/">:2021-:9-:6-:约瑟夫环.md</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="约瑟夫环"><a href="#约瑟夫环" class="headerlink" title="约瑟夫环"></a>约瑟夫环</h1><p>面试时问到了约瑟夫环，tmd一时间没想起，记录一下：</p>
<p>模拟整个删除过程最直观，即构建一个长度为 nn 的链表，各节点值为对应的顺序索引；每轮删除第 mm 个节点，直至链表长度为 1 时结束，返回最后剩余节点的值即可。</p>
<p>模拟法需要循环删除 n - 1n−1 轮，每轮在链表中寻找删除节点需要 mm 次访问操作（链表线性遍历），因此总体时间复杂度为 O(nm)O(nm) 。题目给定的 m, nm,n 取值范围如下所示，观察可知此时间复杂度是不可接受的。<br>$$<br>1 \leq n \leq 10^5 \<br>1 \leq m \leq 10^6<br>$$<br>实际上，本题是著名的 “约瑟夫环” 问题，可使用 动态规划 解决。</p>
<ol>
<li>设f(n,m)表示在n个数字中不断删除第m个数字最后剩下的数字。</li>
<li>第一步删除的元素为(m - 1) % n，用k表示。<br>第二步删除时，起点是k+1,但区间并不是 0 ~ n-2，所以设从第二步的结果是$f^\prime(n-1, m)$则有：<br>$$<br>f(n,m) = f^\prime(n-1, m)<br>$$<br>令$f^\prime(n-1, m) = y,f(n,m) = x$给定x到y的映射关系F则有：<br>$$<br>y = F(x) = (x + k + 1)%n \<br>f(n,m) = \begin{cases}<br>0 &amp; n = 1 \<br>(f(n - 1, m) + m) %n &amp; n &gt; 1<br>\end{cases}<br>$$</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lastRemaining</span>(<span class="params">n: <span class="built_in">number</span>, m: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n === <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> x = lastRemaining(n-<span class="number">1</span> ,m)</span><br><span class="line">    <span class="keyword">return</span> (x + m) % n</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/09/06/2021-9-6-%E7%BA%A6%E7%91%9F%E5%A4%AB%E7%8E%AF-md/" data-id="ckwainvou0004dorj724069jx" data-title=":2021-:9-:6-:约瑟夫环.md" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2021-8-18-React优化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/18/2021-8-18-React%E4%BC%98%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2021-08-18T17:30:36.000Z" itemprop="datePublished">2021-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/18/2021-8-18-React%E4%BC%98%E5%8C%96/">2021-8-18-React优化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="React优化实践"><a href="#React优化实践" class="headerlink" title="React优化实践"></a>React优化实践</h1><h2 id="1-受控组件优化"><a href="#1-受控组件优化" class="headerlink" title="1. 受控组件优化"></a>1. 受控组件优化</h2><p>可控性组件和非可控性的区别就是dom元素值是否与受到react数据状态state控制。一旦由react的state控制数据状态，比如input输入框的值，就会造成这样一个场景，为了使input值实时变化，会不断setState，就会不断触发render函数。例如：</p>
<figure class="highlight typescript"><figcaption><span>jsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Index: React.FC&lt;PropsType&gt; = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [num, setNum] = useState(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">value</span>=<span class="string">&#123;num&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setNum(e.target.value)&#125;/&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ComponentA</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ComponentB</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        &#123;/* 数组生成组件  */&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种情况下如果子组件有<code>componentWillReceiveProps</code>这种副作用的钩子将会引起蝴蝶效应，同时也会重新遍历数组生成组件。</p>
<h2 id="2-React-memo、shouldComponentUpdate和immetable-js控制组件更新"><a href="#2-React-memo、shouldComponentUpdate和immetable-js控制组件更新" class="headerlink" title="2. React.memo、shouldComponentUpdate和immetable.js控制组件更新"></a>2. <code>React.memo</code>、<code>shouldComponentUpdate</code>和<code>immetable.js</code>控制组件更新</h2><p><code>React.memo</code>(<code>shouldComponentUpdate</code>在类组件作用与其类似)是一个高阶组件可以包装组件控制其更新，其第二个参数的函数中两个参数为上次传入组件的<code>props</code>和当前的<code>props</code><br>，可以进行手动比较如果返回<code>false</code>则更新,如不传第二个参数则进行<code>props</code>浅比较，例如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.memo(TextLoop, <span class="function">(<span class="params">prevProps, nextProps</span>) =&gt;</span> prevProps.show === nextProps.show);</span><br></pre></td></tr></table></figure>

<p>Immutable Data 就是一旦创建，就不能再被更改的数据。对 Immutable 对象的任何修改或添加删除操作都会返回一个新的 Immutable 对象。Immutable 实现的原理是 Persistent Data<br>Structure（持久化数据结构），也就是使用旧数据创建新数据时，要保证旧数据同时可用且不变。同时为了避免 deepCopy 把所有节点都复制一遍带来的性能损耗，Immutable 使用了 Structural<br>Sharing（结构共享），即如果对象树中一个节点发生变化，只修改这个节点和受它影响的父节点，其它节点则进行共享。在React中使用可以使只有数据变化的地方更新。</p>
<h2 id="3-组件Props传参"><a href="#3-组件Props传参" class="headerlink" title="3. 组件Props传参"></a>3. 组件Props传参</h2><p><code>props</code>改变会进行一次渲染，如果父组件向子组件传递<code>props</code>使用了以下写法会导致每次子组件都会渲染。</p>
<figure class="highlight typescript"><figcaption><span>jsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;div onClick=&#123;<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;render&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">/&gt;</span><br><span class="line">&lt; ComponentA</span><br><span class="line">    config=&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">value</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>正确的做法是使用<code>useMemo</code>缓存这些箭头函数或对象：</p>
<figure class="highlight typescript"><figcaption><span>jsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [handleClick, config] = useMemo(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;render&#x27;</span>), &#123;<span class="attr">type</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">value</span>: <span class="number">1</span>&#125;]</span><br><span class="line">&#125;, [])</span><br><span class="line"><span class="comment">// ...代码</span></span><br><span class="line">&lt; div</span><br><span class="line">onClick = &#123;handleClick&#125;</span><br><span class="line">/&gt;</span><br><span class="line">&lt; ComponentA</span><br><span class="line">    config=&#123;config&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-从循环中生成组件时key的设置"><a href="#4-从循环中生成组件时key的设置" class="headerlink" title="4. 从循环中生成组件时key的设置"></a>4. 从循环中生成组件时key的设置</h2><p>无论是react 和<br>vue,正确使用key,目的就是在一次循环中，找到与新节点对应的老节点，复用节点，节省开销。不设置肯定是不行的,但是设置为index（拼接为其他字段同理）肯定也是不行的，假设数组中被插入了一组数据那这个key值就是错误的了,<br>所以key一定要设置成唯一值。</p>
<h2 id="5-懒加载-Suspense-和-lazy"><a href="#5-懒加载-Suspense-和-lazy" class="headerlink" title="5. 懒加载 Suspense 和 lazy"></a>5. 懒加载 Suspense 和 lazy</h2><p>Suspense 和 lazy 可以实现 dynamic import 懒加载效果，原理和上述的路由懒加载差不多。在 React 中的使用方法是在 Suspense 组件中使用 <code>&lt;LazyComponent&gt;</code> 组件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LazyComponent = React.lazy(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./LazyComponent&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">LazyComponent</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-虚拟列表与时间分片"><a href="#5-虚拟列表与时间分片" class="headerlink" title="5. 虚拟列表与时间分片"></a>5. 虚拟列表与时间分片</h2><p>虚拟列表的简单实现</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">    state = &#123;</span><br><span class="line">        <span class="attr">list</span>: <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">9999</span>).fill(<span class="number">0</span>).map(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            num++</span><br><span class="line">            <span class="keyword">return</span> num</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="attr">scorllBoxHeight</span>: <span class="number">500</span>, <span class="comment">/* 容器高度(初始化高度) */</span></span><br><span class="line">        <span class="attr">renderList</span>: [],       <span class="comment">/* 渲染列表 */</span></span><br><span class="line">        <span class="attr">itemHeight</span>: <span class="number">60</span>,       <span class="comment">/* 每一个列表高度 */</span></span><br><span class="line">        <span class="attr">bufferCount</span>: <span class="number">8</span>,       <span class="comment">/* 缓冲个数 上下四个 */</span></span><br><span class="line">        <span class="attr">renderCount</span>: <span class="number">0</span>,       <span class="comment">/* 渲染数量 */</span></span><br><span class="line">        <span class="attr">start</span>: <span class="number">0</span>,             <span class="comment">/* 起始索引 */</span></span><br><span class="line">        <span class="attr">end</span>: <span class="number">0</span>                <span class="comment">/* 终止索引 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">listBox</span>: any = <span class="literal">null</span></span><br><span class="line">    <span class="attr">scrollBox</span>: any = <span class="literal">null</span></span><br><span class="line">    <span class="attr">scrollContent</span>: any = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;itemHeight, bufferCount&#125; = <span class="built_in">this</span>.state</span><br><span class="line">        <span class="comment">/* 计算容器高度 */</span></span><br><span class="line">        <span class="keyword">const</span> scorllBoxHeight = <span class="built_in">this</span>.listBox.offsetHeight</span><br><span class="line">        <span class="keyword">const</span> renderCount = <span class="built_in">Math</span>.ceil(scorllBoxHeight / itemHeight) + bufferCount</span><br><span class="line">        <span class="keyword">const</span> end = renderCount + <span class="number">1</span></span><br><span class="line">        <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">            scorllBoxHeight,</span><br><span class="line">            end,</span><br><span class="line">            renderCount,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 处理滚动效果 */</span></span><br><span class="line">    handerScroll = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;scrollTop&#125; :any = <span class="built_in">this</span>.scrollBox</span><br><span class="line">        <span class="keyword">const</span> &#123;itemHeight, renderCount&#125; = <span class="built_in">this</span>.state</span><br><span class="line">        <span class="keyword">const</span> currentOffset = scrollTop - (scrollTop % itemHeight)</span><br><span class="line">        <span class="comment">/* translate3d 开启css cpu 加速 */</span></span><br><span class="line">        <span class="built_in">this</span>.scrollContent.style.transform = <span class="string">`translate3d(0, <span class="subst">$&#123;currentOffset&#125;</span>px, 0)`</span></span><br><span class="line">        <span class="keyword">const</span> start = <span class="built_in">Math</span>.floor(scrollTop / itemHeight)</span><br><span class="line">        <span class="keyword">const</span> end = <span class="built_in">Math</span>.floor(scrollTop / itemHeight + renderCount + <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">            start,</span><br><span class="line">            end,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 性能优化：只有在列表start 和 end 改变的时候在渲染列表 */</span></span><br><span class="line">    <span class="function"><span class="title">shouldComponentUpdate</span>(<span class="params">_nextProps, _nextState</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;start, end&#125; = _nextState</span><br><span class="line">        <span class="keyword">return</span> start !== <span class="built_in">this</span>.state.start || end !== <span class="built_in">this</span>.state.end</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 处理滚动效果 */</span></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">1111</span>)</span><br><span class="line">        <span class="keyword">const</span> &#123;list, scorllBoxHeight, itemHeight, start, end&#125; = <span class="built_in">this</span>.state</span><br><span class="line">        <span class="keyword">const</span> renderList = list.slice(start, end)</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;list_box&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">ref</span>=<span class="string">&#123;(node)</span> =&gt;</span> this.listBox = node&#125;</span></span><br><span class="line"><span class="xml">        &gt;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">scorllBoxHeight</span>, <span class="attr">overflow:</span> &#x27;<span class="attr">scroll</span>&#x27;, <span class="attr">position:</span> &#x27;<span class="attr">relative</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">ref</span>=<span class="string">&#123;(node)</span> =&gt;</span> this.scrollBox = node&#125;</span></span><br><span class="line"><span class="xml">                onScroll=&#123;this.handerScroll&#125;</span></span><br><span class="line"><span class="xml">            &gt;</span></span><br><span class="line"><span class="xml">                &#123; /* 占位作用 */&#125;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> `$&#123;<span class="attr">list.length</span> * <span class="attr">itemHeight</span>&#125;<span class="attr">px</span>`, <span class="attr">position:</span> &#x27;<span class="attr">absolute</span>&#x27;, <span class="attr">left:</span> <span class="attr">0</span>, <span class="attr">top:</span> <span class="attr">0</span>, <span class="attr">right:</span> <span class="attr">0</span>&#125;&#125;/&gt;</span></span></span><br><span class="line"><span class="xml">                &#123; /* 显然区 */&#125;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;(node)</span> =&gt;</span> this.scrollContent = node&#125;</span></span><br><span class="line"><span class="xml">                     style=&#123;&#123;position: &#x27;relative&#x27;, left: 0, top: 0, right: 0&#125;&#125;&gt;</span></span><br><span class="line"><span class="xml">                    &#123;</span></span><br><span class="line"><span class="xml">                        renderList.map((item, index) =&gt; (</span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;list&quot;</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                                &#123;item + &#x27;&#x27;&#125; Item</span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        ))</span></span><br><span class="line"><span class="xml">                    &#125;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>时间分片的概念，就是一次性渲染大量数据，初始化的时候会出现卡顿等现象。使用<code>setTimeout</code> 和 <code>requestAnimationFrame</code>来分片加载数据可以缓解部分情况。</p>
<hr>
<p>参考：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6908895801116721160">https://juejin.cn/post/6908895801116721160</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/18/2021-8-18-React%E4%BC%98%E5%8C%96/" data-id="ckwainvos0002dorj1tb17iyu" data-title="2021-8-18-React优化" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2021-8-13-FastInvSqrt" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/13/2021-8-13-FastInvSqrt/" class="article-date">
  <time class="dt-published" datetime="2021-08-13T10:33:39.000Z" itemprop="datePublished">2021-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/13/2021-8-13-FastInvSqrt/">2021-8-13-FastInvSqrt</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="快速平方根倒数算法"><a href="#快速平方根倒数算法" class="headerlink" title="快速平方根倒数算法"></a>快速平方根倒数算法</h1><p>快速平方根倒数算法也称为平方根倒数速算法(Fast Inverse Square Root)是用于快速计算 的一种算法。此算法由于出现在《雷神之锤III竞技场》源代码中而被人们所熟知。此算法最早被认为是由约翰·卡马克所发明，但后来的调查显示，该算法在这之前就于计算机图形学的硬件与软件领域有所应用，此算法至今为止仍未能确切知晓算法中所使用的特殊常数的起源。<br>下列代码是《雷神之锤III竞技场》源代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">Q_rsqrt</span><span class="params">( <span class="keyword">float</span> number )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> i;</span><br><span class="line">	<span class="keyword">float</span> x2, y;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> threehalfs = <span class="number">1.5F</span>;</span><br><span class="line"> </span><br><span class="line">	x2 = number * <span class="number">0.5F</span>;</span><br><span class="line">	y  = number;</span><br><span class="line">	i  = * ( <span class="keyword">long</span> * ) &amp;y;                       <span class="comment">// evil floating point bit level hacking</span></span><br><span class="line">	i  = <span class="number">0x5f3759df</span> - ( i &gt;&gt; <span class="number">1</span> );               <span class="comment">// what the fuck?</span></span><br><span class="line">	y  = * ( <span class="keyword">float</span> * ) &amp;i;</span><br><span class="line">	y  = y * ( threehalfs - ( x2 * y * y ) );   <span class="comment">// 1st iteration </span></span><br><span class="line">    <span class="comment">// y  = y * ( threehalfs - ( x2 * y * y ) );   // 2nd iteration, this can be removed</span></span><br><span class="line"> </span><br><span class="line">	<span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-浮点数存储方式（IEEE754）"><a href="#1-浮点数存储方式（IEEE754）" class="headerlink" title="1. 浮点数存储方式（IEEE754）"></a>1. 浮点数存储方式（IEEE754）</h2><p>一个浮点数以32个二进制位表示一个有理数，而这32位由其意义分为三段：首先首位为符号位（si），如若是0则为正数，反之为负数；接下来的8位表示经过偏移处理（这是为了使之能表示-127－128, 偏移量B=127,E为指数值）后的指数；最后23位表示的则是有效数字中除最高位以外的其余数字(m)。公式表示：<br>$$<br>x=(-1)^{si}*(1+m)<em>2^{(E-B)}\<br>$$<br>例如： 0-01111100-0100000000000000000000 $= (-1)^{0}</em>(1+0.250)*2^{(124-127)} = 0.15625$  </p>
<p>如果用浮点数序列表示整数，符号位占1位，数值占31位，则正整数为：$I = E * 2^{23} + M$,即$I = 124 * 2^{23} + 2^{21}$对于同样的32位二进制数码，若为浮点数表示时实际数值为$x=(1+m_x)2^{e_x}$，而若为整数表示时实际数值则为 $I_x=E_xL+M_x$，其中 $L=2^{n-1-b}$，这里n=32，b=8。式子中引入的新变量为：</p>
<p>等式1：<br>$$m_x=\frac{M_x}{L}\$$<br>等式2：<br>$$e_x = E_x - B,其中B = 2^{b-1} - 1$$</p>
<h2 id="2-浮点数平方根倒数近似值"><a href="#2-浮点数平方根倒数近似值" class="headerlink" title="2. 浮点数平方根倒数近似值"></a>2. 浮点数平方根倒数近似值</h2><p>平方根倒数方程<br>$$y=\frac{1}{\sqrt{x}}\$$<br>取对数：<br>$$\log_2y = -\frac{1}{2}\log_2x\$$<br>因为浮点数可表示为：$x=(1+m_x)*2^{e_x}$ 所以有$y=(1+m_y)*2^{e_y}$, 代入上式有：<br>$$<br>\log_2(1+m_y) + e_y = -\frac{1}{2}\log_2(1+m_x) - \frac{1}{2}e_x<br>$$<br>再度引入新数$\sigma$描述$\log_2{(1+x)}$与近似值R间的误差：由于$0 \le x &lt; 1$ ，有$\log_2{(1+x)}\approx {x}$，则在此可定义$\sigma$与$x$的关系为$\log_2{(1+x)}\cong x+\sigma$，其中$\sigma$介于0到$\frac{1}{3}$，所以将$\log_2{(1+x)}= x+\sigma$代入上式得：<br>$$m_y+\sigma+e_y=-\frac{1}{2}m_x-\frac{1}{2}\sigma-\frac{1}{2}e_x$$<br>将之前等式1，等式2代入到上述方程中，有：<br>$$M_y+(E_y-B)L=-\frac{3}{2}\sigma{L}-\frac{1}{2}M_x-\frac{1}{2}(E_x-B)L$$<br>移项整理得：<br>$$E_yL+M_y=\frac{3}{2}(B-\sigma)L-\frac{1}{2}(E_xL+M_x)$$<br>又因为浮点规格存储的正浮点数x，若将其作为长整型表示，则示值为：$I_x=E_xL+M_x$，所以x的平方根倒数的首次近似值的整数表示值为：<br>$$I_y=E_yL+M_y=R-\frac{1}{2}(E_xL+M_x)=R-\frac{1}{2}I_x，\其中R=\frac{3}{2}(B-\sigma)L，B=2^{b-1}-1 L=2^{n-1-b}，n=32，b=8。$$<br>这个式子对应着源代码中的这一行：<code>i  = 0x5f3759df - ( i &gt;&gt; 1 );</code>，然后将整数表示值换回表示浮点数：<code>y  = * ( float * ) &amp;i;</code>。这样就得到了浮点数的平方根倒数的近似值。<br>由第三部分可知：0x5f3759df 对应着R，即3/2(B-$\sigma$)L.当R为0x5f3759df时值最精准。</p>
<p>“现在不仅该算法的原作者不明，人们也仍无法明确当初选择这个“魔术数字”的方法。Chris Lomont在研究中曾做了个试验：他编写了一个函数，以在一个范围内遍历选取R值的方式将逼近误差降到最小，以此方法他计算出了线性近似的最优R值0x5f37642f（与代码中使用的0x5f3759df相当接近），但以之代入算法计算并进行一次牛顿迭代后，所得近似值与代入0x5f3759df的结果相比精度却仍略微更低。……在Charles McEniry的论文中，他使用了一种类似Lomont但更复杂的方法来优化R值：他最开始使用穷举搜索，所得结果与Lomont相同；而后他尝试用带权二分法寻找最优值，所得结果恰是代码中所使用的魔术数字0x5f3759df”——维基百科</p>
<p>最后使用牛顿迭代法使答案逼近<br>牛顿迭代法：设方程 y = f(x) - 0;已知y求x,先取得x的一个近似值$x_0$,设k为$x_0$处切线斜率：<br>$$<br>y_1 - y_0 = k(x_1-x_0)\<br>0-y_0 = k(x_1-x_0)\<br>x_1 = x_0-\frac{y_0}{k}\<br>x_1= x_0 \frac{f(x_0)}{f^{‘}{x_0}}<br>$$<br>反复重复以上步骤获得更精确的值：<br>$$x_{n+1} = x_n-\frac{f(x_n)}{f^{‘}{x_n}}$$</p>
<h1 id="tmd我怎么就写不出来！"><a href="#tmd我怎么就写不出来！" class="headerlink" title="tmd我怎么就写不出来！"></a>tmd我怎么就写不出来！</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/13/2021-8-13-FastInvSqrt/" data-id="ckwainvoq0001dorjelf18r4b" data-title="2021-8-13-FastInvSqrt" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li></ul>

    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 20px;">算法</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/11/22/2021-11-22-generator%E5%92%8Cjs%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88-md/">2021-11-22-generator和js调用堆栈.md</a>
          </li>
        
          <li>
            <a href="/2021/11/22/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2021/09/06/2021-9-6-%E7%BA%A6%E7%91%9F%E5%A4%AB%E7%8E%AF-md/">:2021-:9-:6-:约瑟夫环.md</a>
          </li>
        
          <li>
            <a href="/2021/08/18/2021-8-18-React%E4%BC%98%E5%8C%96/">2021-8-18-React优化</a>
          </li>
        
          <li>
            <a href="/2021/08/13/2021-8-13-FastInvSqrt/">2021-8-13-FastInvSqrt</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 XiaoMao<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>